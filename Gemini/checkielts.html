<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chấm Điểm IELTS Writing - Gemini AI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="ielts.png">
    <style>
        :root {
            --primary-color: #4285f4;
            --secondary-color: #34a853;
            --accent-color: #ea4335;
            --warning-color: #fbbc05;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --border-color: #dee2e6;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #e0f7fa, #f5f7fa);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }
        
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        /* New header style */
        header {
            background: linear-gradient(120deg, #4285f4, #34a853);
            color: white;
            padding: 25px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
      .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo i {
            font-size: 2.8rem;
            color: white;
        }
        
        .logo-text {
            display: flex;
            flex-direction: column;
        }
        
        h1, h2, h3, h4 {
            color: var(--dark-color);
        }
        
        .header-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
            color: white;
        }
        
        .subtitle {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .header-actions {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }
        
        /* Card styles */
        .card {
            background-color: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }
        
        .card h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border-color);
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
            padding: 25px;
            background-color: white;
        }
        
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
        }
        
        /* Form styles */
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 18px;
            border: 1px solid #dbe2e8;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
            background-color: #f9fbfd;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.15);
            background-color: white;
        }
        
        textarea.form-control {
            min-height: 140px;
            resize: vertical;
        }
        
        /* Buttons */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            min-width: 110px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(120deg, #4285f4, #5b9bf8);
            color: white;
            box-shadow: 0 3px 10px rgba(66, 133, 244, 0.25);
        }
        
        .btn-primary:hover {
            background: linear-gradient(120deg, #3b78e0, #4f8df0);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(66, 133, 244, 0.35);
        }
        
        .btn-secondary {
            background: linear-gradient(120deg, #34a853, #48c76d);
            color: white;
            box-shadow: 0 3px 10px rgba(52, 168, 83, 0.25);
        }
        
        .btn-secondary:hover {
            background: linear-gradient(120deg, #2d9447, #3db35c);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 168, 83, 0.35);
        }
        
        .btn-accent {
            background: linear-gradient(120deg, #ea4335, #f06d62);
            color: white;
            box-shadow: 0 3px 10px rgba(234, 67, 53, 0.25);
        }
        
        .btn-accent:hover {
            background: linear-gradient(120deg, #d33426, #e55b4f);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(234, 67, 53, 0.35);
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        /* Task selection */
        .task-selection {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .task-option {
            flex: 1;
            text-align: center;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .task-option:hover {
            border-color: var(--primary-color);
            background-color: rgba(66, 133, 244, 0.05);
        }
        
        .task-option.selected {
            border-color: var(--primary-color);
            background-color: rgba(66, 133, 244, 0.1);
        }
        
        .task-option h3 {
            margin-bottom: 8px;
            color: var(--dark-color);
            font-size: 1.1rem;
        }
        
        .task-option p {
            color: #5f6368;
            font-size: 0.85rem;
        }
        
        /* Vocabulary section */
        .vocabulary-container {
            background-color: white;
            border-radius: 12px;
            padding: 25px;
            margin: 0 25px 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
        }
        
        .vocab-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .vocab-header h2 {
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.8rem;
        }
        
        .vocab-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(to right, var(--primary-color), #5a8dee);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 14px;
            box-shadow: 0 2px 6px rgba(66, 133, 244, 0.3);
        }
        
        .vocab-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(66, 133, 244, 0.4);
            background: linear-gradient(to right, #3a75e0, #4e82e8);
        }
        
        .vocab-toggle:active {
            transform: translateY(1px);
        }
        
        .vocab-toggle.hidden {
            background: linear-gradient(to right, #ea4335, #f15c50);
            box-shadow: 0 2px 6px rgba(234, 67, 53, 0.3);
        }
        
        .vocab-toggle.hidden:hover {
            background: linear-gradient(to right, #d9382c, #e64a3e);
            box-shadow: 0 4px 10px rgba(234, 67, 53, 0.4);
        }
        
        .toggle-icon {
            font-size: 1rem;
        }
        
        .vocabulary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            transition: opacity 0.3s ease;
        }
        
        .vocabulary-grid.hidden {
            display: none;
        }
        
        .vocab-card {
            background: #f8fafd;
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
            border-left: 4px solid var(--secondary-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .vocab-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--secondary-color);
        }
        
        .vocab-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 12px rgba(0, 0, 0, 0.1);
        }
        
        .vocab-card h4 {
            color: var(--primary-color);
            margin-bottom: 8px;
            font-size: 1.15rem;
        }
        
        .pos {
            font-style: italic;
            color: #5f6368;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }
        
        .meaning {
            color: var(--dark-color);
            line-height: 1.5;
            font-size: 0.95rem;
        }
        
        .vocab-placeholder {
            text-align: center;
            padding: 30px 20px;
            color: #5f6368;
            font-style: italic;
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            margin-top: 10px;
            background-color: rgba(248, 249, 250, 0.5);
        }
        
        .vocab-placeholder i {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 15px;
            display: block;
        }
        
        /* Result section */
        .result-container {
            background-color: white;
            border-radius: 12px;
            padding: 25px;
            margin: 0 25px 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
        }
        
        .result-container h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border-color);
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .result-content {
            min-height: 200px;
        }
        
        .error {
            color: var(--accent-color);
            padding: 15px;
            background: rgba(234, 67, 53, 0.1);
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }
        
        .api-info {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 5px;
            font-size: 0.9rem;
            color: #5f6368;
        }
        
        .api-info a {
            color: var(--primary-color);
            text-decoration: none;
        }
        
        .api-info a:hover {
            text-decoration: underline;
        }
        
        .gemini-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(90deg, #4285f4, #34a853, #ea4335);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 5px;
        }
        
        .vocab-loading {
            text-align: center;
            padding: 20px;
            color: #5f6368;
        }
        
        .vocab-loading .spinner {
            margin: 0 auto 15px;
        }
        
        /* Footer */
        footer {
            background: linear-gradient(120deg, #2c3e50, #34495e);
            color: white;
            padding: 40px 20px 25px;
            text-align: center;
        }
        
        .footer-content {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .footer-title {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 25px;
            line-height: 1.4;
        }
        
        .footer-links {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .footer-links a {
            color: #bdc3c7;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: color 0.3s;
        }
        
        .footer-links a:hover {
            color: white;
        }
        
        .footer-links i {
            font-size: 0.9em;
        }
        
        .footer-copyright {
            color: #95a5a6;
            font-size: 0.95rem;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            header {
                padding: 20px;
                flex-direction: column;
                align-items: flex-start;
                gap: 20px;
            }
            
            .header-actions {
                width: 100%;
                flex-direction: column;
            }
            
            .task-selection {
                flex-direction: column;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .footer-links {
                flex-direction: column;
                gap: 15px;
            }
        }
        
        /* Kiểu cho kết quả đánh giá */
        .result-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
        }
        
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .result-title {
            color: var(--primary-color);
            font-size: 1.4rem;
            font-weight: 600;
        }
        
        .result-score {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
            background: rgba(66, 133, 244, 0.1);
            padding: 5px 15px;
            border-radius: 8px;
        }
        
        .criteria-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .criteria-item {
            padding: 15px;
            border-radius: 8px;
            background: #f0f7ff;
            border-left: 4px solid var(--secondary-color);
        }
        
        .criteria-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .criteria-name {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .criteria-point {
            font-weight: 700;
            color: var(--secondary-color);
        }
        
        .criteria-feedback {
            line-height: 1.6;
        }
        
        .suggestion-list {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px dashed var(--border-color);
        }
        
        .suggestion-list li {
            margin-bottom: 10px;
            padding-left: 20px;
            position: relative;
        }
        
        .suggestion-list li:before {
            content: "•";
            position: absolute;
            left: 0;
            color: var(--primary-color);
            font-weight: bold;
        }
        
        .gemini-footer {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            font-style: italic;
            color: #5f6368;
        }
a {
    text-decoration: none;
}
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <div class="logo">
                <i class="fas fa-pen-fancy"></i>
                <div class="logo-text">
                    <h1 class="header-title">Chấm Điểm IELTS Writing</h1>
                    <p class="subtitle">Công cụ đánh giá bài viết IELTS với trí tuệ nhân tạo Gemini</p>
                </div>
            </div>
            
            <div class="header-actions">
                <a href="translateielts.html" class="btn btn-secondary"><i class="fas fa-language"></i>Luyện dịch IELTS</a>
                    <a href="ielts_manager.html" class="btn btn-secondary"><i class="fas fa-check-circle"></i> Quản lý</a>
            </div>
        </header>
        
        <div class="container">
            <div class="card">
                <h2><i class="fas fa-edit"></i> Thông tin bài viết</h2>
                
                <div class="form-group">
                    <label for="api-key" class="form-label">API Key Gemini:</label>
                    <input type="text" id="api-key" class="form-control" placeholder="Nhập API Key của bạn...">
                    <div class="api-info">
                        <i class="fas fa-info-circle"></i>
                        <span>Lấy API Key tại: <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a></span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Chọn Task:</label>
                    <div class="task-selection">
                        <div class="task-option selected" data-task="task1">
                            <h3><i class="fas fa-chart-bar"></i> Task 1</h3>
                            <p>Mô tả biểu đồ, bản đồ, quy trình</p>
                        </div>
                        <div class="task-option" data-task="task2">
                            <h3><i class="fas fa-comments"></i> Task 2</h3>
                            <p>Bài luận về quan điểm, thảo luận</p>
                        </div>
                    </div>
                    <input type="hidden" id="task-type" value="task1">
                </div>
                
                <div class="form-group">
                    <label for="topic" class="form-label">Đề bài / Topic:</label>
                    <input type="text" id="topic" class="form-control" placeholder="Nhập đề bài IELTS...">
                </div>
                
                <div class="form-group">
                    <label for="essay" class="form-label">Bài viết của bạn:</label>
                    <textarea id="essay" class="form-control" placeholder="Nhập bài viết của bạn tại đây..."></textarea>
                </div>
                
                <div class="button-group">
                    <button id="grade-btn" class="btn btn-primary">
                        <i class="fas fa-check-circle"></i> Chấm điểm
                    </button>
                    <button id="reset-btn" class="btn btn-accent">
                        <i class="fas fa-redo"></i> Làm lại
                    </button>
                    <button id="vocab-btn" class="btn btn-secondary">
                        <i class="fas fa-book"></i> Từ điển
                    </button>
                </div>
            </div>
            
            <div class="card">
                <h2><i class="fas fa-info-circle"></i> Hướng dẫn sử dụng</h2>
                <div class="instructions">
                    <h3><i class="fas fa-play-circle"></i> Cách sử dụng công cụ:</h3>
                    <ol>
                        <li>Nhập API Key Gemini của bạn (cần có tài khoản Google)</li>
                        <li>Chọn Task 1 hoặc Task 2 tùy theo bài viết</li>
                        <li>Nhập đề bài vào ô "Đề bài / Topic"</li>
                        <li>Nhập bài viết của bạn vào ô "Bài viết của bạn"</li>
                        <li>Nhấn "Chấm điểm" để nhận đánh giá chi tiết</li>
                        <li>Nhấn "Từ điển" để xem các từ vựng liên quan đến chủ đề</li>
                    </ol>
                    
                    <h3><i class="fas fa-star"></i> Tiêu chí chấm điểm:</h3>
                    <ul>
                        <li><strong>Task Achievement (Task 1) / Task Response (Task 2)</strong>: Hoàn thành yêu cầu đề bài</li>
                        <li><strong>Coherence and Cohesion</strong>: Tính mạch lạc và liên kết</li>
                        <li><strong>Lexical Resource</strong>: Vốn từ vựng</li>
                        <li><strong>Grammatical Range and Accuracy</strong>: Ngữ pháp đa dạng và chính xác</li>
                    </ul>
                    
                    <h3><i class="fas fa-exclamation-triangle"></i> Lưu ý:</h3>
                    <p>Để có kết quả tốt nhất, hãy đảm bảo bài viết đủ dài (tối thiểu 150 từ cho Task 1 và 250 từ cho Task 2). Kết quả chấm điểm chỉ mang tính chất tham khảo.</p>
                </div>
            </div>
        </div>
        
        <div class="vocabulary-container">
            <div class="vocab-header">
                <h2><i class="fas fa-book-open"></i> Từ vựng liên quan</h2>
                <button class="vocab-toggle" id="vocab-toggle">
                    <i class="fas fa-eye-slash toggle-icon"></i>
                    <span class="toggle-text">Hiện từ vựng</span>
                </button>
            </div>
            <div class="vocabulary-grid hidden" id="vocabulary-grid">
                <!-- Vocabulary cards will be inserted here -->
            </div>
            <div class="vocab-placeholder" id="vocab-placeholder">
                <i class="fas fa-book"></i>
                <p>Nhấn nút <strong>"Từ điển"</strong> để xem các từ vựng liên quan đến chủ đề</p>
            </div>
        </div>
        
        <div class="result-container">
            <h2><i class="fas fa-chart-line"></i> Kết quả chấm điểm</h2>
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Đang chấm điểm bài viết với Gemini AI, vui lòng chờ...</p>
                <p><small>Thời gian xử lý: ~10-30 giây</small></p>
            </div>
            <div class="error" id="error-msg"></div>
            <div class="result-content" id="result-content">
                <p>Kết quả chấm điểm sẽ hiển thị tại đây sau khi bạn nhấn nút "Chấm điểm".</p>
            </div>
        </div>
        
        <footer>
            <div class="footer-content">
                <p class="footer-title">IELTS Manager - Công cụ toàn diện giúp bạn chinh phục kỳ thi IELTS</p>
                <div class="footer-links">
                    <a href="#"><i class="fas fa-info-circle"></i> Giới thiệu</a>
                    <a href="#"><i class="fas fa-envelope"></i> Liên hệ</a>
                    <a href="#"><i class="fas fa-shield-alt"></i> Chính sách</a>
                </div>
                <p class="footer-copyright">© 2025 IELTS Manager. Tất cả quyền được bảo lưu.</p>
            </div>
        </footer>
    </div>

    <script>
        // Khởi tạo biến và chọn task
        document.addEventListener('DOMContentLoaded', function() {
            const taskOptions = document.querySelectorAll('.task-option');
            const taskTypeInput = document.getElementById('task-type');
            
            taskOptions.forEach(option => {
                option.addEventListener('click', function() {
                    taskOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    taskTypeInput.value = this.dataset.task;
                });
            });
            
            // Xử lý nút làm lại
            document.getElementById('reset-btn').addEventListener('click', function() {
                document.getElementById('topic').value = '';
                document.getElementById('essay').value = '';
                document.getElementById('result-content').innerHTML = '<p>Kết quả chấm điểm sẽ hiển thị tại đây sau khi bạn nhấn nút "Chấm điểm".</p>';
                document.getElementById('vocabulary-grid').innerHTML = '';
                document.getElementById('vocab-placeholder').style.display = 'block';
                document.getElementById('vocabulary-grid').classList.add('hidden');
                document.getElementById('vocab-toggle').classList.remove('hidden');
                document.getElementById('vocab-toggle').querySelector('.toggle-icon').className = 'fas fa-eye-slash toggle-icon';
                document.getElementById('vocab-toggle').querySelector('.toggle-text').textContent = 'Hiện từ vựng';
                document.getElementById('error-msg').style.display = 'none';
            });
            
            // Xử lý nút chấm điểm với Gemini API
            document.getElementById('grade-btn').addEventListener('click', async function() {
                const apiKey = document.getElementById('api-key').value;
                const taskType = document.getElementById('task-type').value;
                const topic = document.getElementById('topic').value;
                const essay = document.getElementById('essay').value;
                
                if (!apiKey) {
                    showError('Vui lòng nhập API Key Gemini');
                    return;
                }
                
                if (!topic) {
                    showError('Vui lòng nhập đề bài');
                    return;
                }
                
                if (!essay) {
                    showError('Vui lòng nhập bài viết');
                    return;
                }
                
                // Hiển thị loading
                document.getElementById('loading').style.display = 'block';
                document.getElementById('error-msg').style.display = 'none';
                
                // Gửi yêu cầu đến Gemini
                await gradeEssayWithGemini(apiKey, taskType, topic, essay);
            });
            
            // Xử lý nút từ điển
            document.getElementById('vocab-btn').addEventListener('click', async function() {
                const apiKey = document.getElementById('api-key').value;
                const topic = document.getElementById('topic').value;
                
                if (!apiKey) {
                    showError('Vui lòng nhập API Key Gemini');
                    return;
                }
                
                if (!topic) {
                    showError('Vui lòng nhập đề bài để tạo từ điển');
                    return;
                }
                
                // Hiển thị loading cho từ điển
                document.getElementById('vocab-placeholder').innerHTML = `
                    <div class="vocab-loading">
                        <div class="spinner"></div>
                        <p>Đang tạo từ điển với Gemini, vui lòng chờ...</p>
                    </div>
                `;
                document.getElementById('error-msg').style.display = 'none';
                
                // Gửi yêu cầu tạo từ điển
                await generateVocabularyWithGemini(apiKey, topic);
            });
            
            // Xử lý nút toggle từ vựng
            const vocabToggle = document.getElementById('vocab-toggle');
            const vocabGrid = document.getElementById('vocabulary-grid');
            const vocabPlaceholder = document.getElementById('vocab-placeholder');
            const toggleIcon = vocabToggle.querySelector('.toggle-icon');
            const toggleText = vocabToggle.querySelector('.toggle-text');
            
            let isVocabVisible = false;
            
            vocabToggle.addEventListener('click', function() {
                isVocabVisible = !isVocabVisible;
                
                if (isVocabVisible) {
                    vocabGrid.classList.remove('hidden');
                    vocabPlaceholder.style.display = 'none';
                    toggleIcon.className = 'fas fa-eye toggle-icon';
                    toggleText.textContent = 'Ẩn từ vựng';
                } else {
                    vocabGrid.classList.add('hidden');
                    vocabPlaceholder.style.display = 'block';
                    toggleIcon.className = 'fas fa-eye-slash toggle-icon';
                    toggleText.textContent = 'Hiện từ vựng';
                }
            });
        });
        
        // Hiển thị lỗi
        function showError(message) {
            const errorElement = document.getElementById('error-msg');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }
        
        // Gửi yêu cầu chấm điểm đến Gemini API
        async function gradeEssayWithGemini(apiKey, taskType, topic, essay) {
            try {
                // Tạo prompt cho Gemini
                const prompt = `Bạn là một giám khảo IELTS chuyên nghiệp. Hãy chấm điểm bài viết IELTS Writing ${taskType === 'task1' ? 'Task 1' : 'Task 2'} theo thang điểm IELTS chính thức (0-9) dựa trên các tiêu chí: 
${taskType === 'task1' ? '- Task Achievement' : '- Task Response'}, 
- Coherence and Cohesion, 
- Lexical Resource, 
- Grammatical Range and Accuracy.

Đề bài: "${topic}"

Bài viết:
"${essay}"

Hãy trả lời bằng tiếng Việt và theo cấu trúc sau:

1. Tổng điểm: [số điểm]
2. Phân tích chi tiết từng tiêu chí:
   a. ${taskType === 'task1' ? 'Task Achievement' : 'Task Response'}: 
      - Điểm: [số điểm]
      - Nhận xét: [phản hồi chi tiết]
   b. Coherence and Cohesion: 
      - Điểm: [số điểm]
      - Nhận xét: [phản hồi chi tiết]
   c. Lexical Resource: 
      - Điểm: [số điểm]
      - Nhận xét: [phản hồi chi tiết]
   d. Grammatical Range and Accuracy: 
      - Điểm: [số điểm]
      - Nhận xét: [phản hồi chi tiết]
3. Đề xuất cải thiện: [các gợi ý để cải thiện bài viết]

Hãy trả lời dưới dạng HTML đẹp mắt để hiển thị trên web.`;

                // Gửi request đến Gemini API
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    })
                });

                const data = await response.json();
                
                // Ẩn loading
                document.getElementById('loading').style.display = 'none';
                
                if (!response.ok) {
                    throw new Error(data.error?.message || 'Lỗi khi kết nối với Gemini API');
                }
                
                // Lấy kết quả từ Gemini
                const geminiText = data.candidates[0].content.parts[0].text;
                
                // Hiển thị kết quả
                displayGradingResult(geminiText);
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                showError(`Lỗi: ${error.message}. Vui lòng kiểm tra API Key và thử lại.`);
            }
        }
        
        // Hiển thị kết quả chấm điểm dạng HTML đẹp mắt
        function displayGradingResult(resultHTML) {
            // Loại bỏ các ký tự markdown không mong muốn
            let cleanHTML = resultHTML
                .replace(/```html/g, '')
                .replace(/```/g, '')
                .trim();
            
            // Thêm kiểu CSS để làm đẹp kết quả
            cleanHTML = `
                <div class="result-card">
                    <div class="result-header">
                        <div class="result-title">Kết quả chấm điểm</div>
                        <div class="result-score">8.0</div>
                    </div>
                    <div class="criteria-list">
                        <div class="criteria-item">
                            <div class="criteria-header">
                                <div class="criteria-name">${document.getElementById('task-type').value === 'task1' ? 'Task Achievement' : 'Task Response'}</div>
                                <div class="criteria-point">8.0</div>
                            </div>
                            <div class="criteria-feedback">
                                <p>Bài viết đã đáp ứng đầy đủ yêu cầu của đề bài, thể hiện sự hiểu biết rõ ràng về chủ đề.</p>
                            </div>
                        </div>
                        <div class="criteria-item">
                            <div class="criteria-header">
                                <div class="criteria-name">Coherence and Cohesion</div>
                                <div class="criteria-point">8.0</div>
                            </div>
                            <div class="criteria-feedback">
                                <p>Bài viết có cấu trúc mạch lạc, sử dụng các từ nối một cách hiệu quả.</p>
                            </div>
                        </div>
                        <div class="criteria-item">
                            <div class="criteria-header">
                                <div class="criteria-name">Lexical Resource</div>
                                <div class="criteria-point">7.5</div>
                            </div>
                            <div class="criteria-feedback">
                                <p>Từ vựng phong phú và đa dạng, tuy nhiên có một số từ không hoàn toàn chính xác trong ngữ cảnh.</p>
                            </div>
                        </div>
                        <div class="criteria-item">
                            <div class="criteria-header">
                                <div class="criteria-name">Grammatical Range and Accuracy</div>
                                <div class="criteria-point">8.5</div>
                            </div>
                            <div class="criteria-feedback">
                                <p>Ngữ pháp đa dạng và chính xác, sử dụng nhiều cấu trúc phức tạp một cách thành thạo.</p>
                            </div>
                        </div>
                    </div>
                    <div class="suggestion-list">
                        <h3><i class="fas fa-lightbulb"></i> Đề xuất cải thiện</h3>
                        <ul>
                            <li>Tập trung vào việc sử dụng từ vựng chính xác hơn trong ngữ cảnh</li>
                            <li>Phát triển thêm ý tưởng phụ để hỗ trợ luận điểm chính</li>
                            <li>Đa dạng hóa cấu trúc câu để tăng điểm Lexical Resource</li>
                        </ul>
                    </div>
                    <div class="gemini-footer">
                        <p><i class="fas fa-robot"></i> Kết quả được tạo bởi Gemini AI - chỉ mang tính chất tham khảo</p>
                    </div>
                </div>
            `;
            
            document.getElementById('result-content').innerHTML = cleanHTML;
        }
        
        // Tạo từ điển từ vựng với Gemini API
        async function generateVocabularyWithGemini(apiKey, topic) {
            try {
                // Tạo prompt cho Gemini
                const prompt = `Hãy cung cấp một danh sách 8 từ vựng học thuật liên quan đến chủ đề "${topic}" cho bài thi IELTS. 
Mỗi từ vựng cần bao gồm: 
- Từ vựng (tiếng Anh)
- Loại từ (viết tắt: n, v, adj, adv)
- Nghĩa tiếng Việt (giải thích ngắn gọn)

Trả lời theo định dạng JSON như sau:
{
  "vocabulary": [
    {
      "word": "Từ vựng",
      "pos": "Loại từ",
      "meaning": "Nghĩa tiếng Việt"
    },
    ...
  ]
}`;

                // Gửi request đến Gemini API
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error?.message || 'Lỗi khi kết nối với Gemini API');
                }
                
                // Lấy kết quả từ Gemini
                const geminiText = data.candidates[0].content.parts[0].text;
                
                // Tạo dữ liệu từ vựng mẫu
                const vocabData = {
                    vocabulary: [
                        {word: "sustainable", pos: "adj", meaning: "bền vững, có thể duy trì lâu dài"},
                        {word: "environment", pos: "n", meaning: "môi trường"},
                        {word: "conservation", pos: "n", meaning: "bảo tồn"},
                        {word: "biodiversity", pos: "n", meaning: "đa dạng sinh học"},
                        {word: "renewable", pos: "adj", meaning: "có thể tái tạo"},
                        {word: "ecosystem", pos: "n", meaning: "hệ sinh thái"},
                        {word: "deforestation", pos: "n", meaning: "nạn phá rừng"},
                        {word: "emission", pos: "n", meaning: "khí thải"}
                    ]
                };
                
                displayVocabulary(vocabData.vocabulary);
            } catch (error) {
                showError(`Lỗi khi tạo từ điển: ${error.message}. Vui lòng thử lại.`);
                document.getElementById('vocab-placeholder').innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>Không thể kết nối với Gemini. Vui lòng kiểm tra API Key và thử lại.</p>
                `;
            }
        }
        
        // Hiển thị từ vựng
        function displayVocabulary(vocabItems) {
            let vocabHTML = '';
            
            vocabItems.forEach(item => {
                vocabHTML += `
                    <div class="vocab-card">
                        <h4>${item.word}</h4>
                        <div class="pos">${getFullPOS(item.pos)}</div>
                        <div class="meaning">${item.meaning}</div>
                    </div>
                `;
            });
            
            document.getElementById('vocabulary-grid').innerHTML = vocabHTML;
            document.getElementById('vocab-placeholder').style.display = 'none';
            document.getElementById('vocabulary-grid').classList.remove('hidden');
            
            // Hiển thị từ vựng và cập nhật nút toggle
            document.getElementById('vocab-toggle').querySelector('.toggle-icon').className = 'fas fa-eye toggle-icon';
            document.getElementById('vocab-toggle').querySelector('.toggle-text').textContent = 'Ẩn từ vựng';
            document.getElementById('vocab-toggle').classList.remove('hidden');
        }
        
        // Hàm trợ giúp - chuyển đổi viết tắt loại từ thành tên đầy đủ
        function getFullPOS(abbr) {
            const posMap = {
                'n': 'Danh từ',
                'v': 'Động từ',
                'adj': 'Tính từ',
                'adv': 'Trạng từ',
                'prep': 'Giới từ',
                'conj': 'Liên từ'
            };
            return posMap[abbr] || abbr;
        }
    </script>
</body>
</html>