<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luyện Viết Câu với AI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Reset CSS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --accent-color: #4895ef;
            --success-color: #4cc9f0;
            --warning-color: #f72585;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --gray-color: #6c757d;
            --border-color: #dee2e6;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        body {
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }

        /* Header Styles */
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1rem 0;
            box-shadow: var(--card-shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo i {
            color: var(--success-color);
        }

        .nav-links {
            display: flex;
            gap: 1.5rem;
        }

        .nav-links a {
            color: rgba(255, 255, 255, 0.85);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s;
            padding: 0.5rem;
            border-radius: 4px;
        }

        .nav-links a:hover, 
        .nav-links a.active {
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Main Content Styles */
        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            padding: 2rem 0;
        }

        @media (min-width: 992px) {
            .main-content {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* Card Styles */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
            transition: transform 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            padding: 1.25rem;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .card-body {
            padding: 1.5rem;
        }

        /* API Key Section */
        .api-key-section {
            background: #fff;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
        }

        .api-form {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .api-form input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .api-form input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--secondary-color);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background: #3ab0d9;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
        }

        .btn-outline:hover {
            background: var(--primary-color);
            color: white;
        }

        /* Practice Section */
        .vietnamese-text {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            text-align: center;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }

        .translation-input textarea {
            width: 100%;
            min-height: 150px;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1.1rem;
            resize: vertical;
            transition: all 0.3s;
        }

        .translation-input textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .action-buttons .btn {
            flex: 1;
            min-width: 120px;
        }

        /* Feedback Section */
        .feedback-content {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            min-height: 200px;
        }

        .feedback-title {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .suggestion-text {
            font-size: 1.1rem;
            line-height: 1.7;
            margin-bottom: 1rem;
            padding: 1rem;
            background-color: #e8f4fd;
            border-radius: 8px;
            border-left: 4px solid var(--success-color);
        }

        .error-list {
            list-style-type: none;
            padding-left: 0;
        }

        .error-list li {
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            background-color: #fff4f4;
            border-left: 4px solid var(--warning-color);
            border-radius: 4px;
        }

        .error-list li::before {
            content: "•";
            color: var(--warning-color);
            font-weight: bold;
            display: inline-block;
            width: 1em;
            margin-left: -1em;
        }

        .summary {
            font-style: italic;
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: #f0f7ff;
            border-radius: 8px;
            border-left: 4px solid var(--accent-color);
        }

        /* Footer */
        footer {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
            padding: 2rem 0;
            margin-top: 3rem;
        }

        .footer-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .social-links {
            display: flex;
            gap: 1.5rem;
            font-size: 1.5rem;
        }

        .social-links a {
            color: white;
            transition: all 0.3s;
        }

        .social-links a:hover {
            color: var(--success-color);
            transform: translateY(-3px);
        }

        /* Spinner */
        .spinner {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
            color: var(--primary-color);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }
            
            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .action-buttons .btn {
                flex: 100%;
            }
            
            .api-form {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-pen-fancy"></i>
                    <span>Luyện Viết Câu với AI</span>
                </div>
                <div class="nav-links">
                    <a href="#" class="active">Luyện viết</a>
                    <a href="#">Hướng dẫn</a>
                    <a href="#">Tài nguyên</a>
                </div>
            </div>
        </div>
    </header>

    <!-- API Key Section -->
    <div class="container">
        <div class="api-key-section">
            <h2><i class="fas fa-key"></i> Cài đặt Gemini API</h2>
            <p>Nhập API Key của bạn để sử dụng Gemini AI. Nếu chưa có key, bạn có thể tạo tại 
                <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a>.</p>
            
            <div class="api-form">
                <input type="password" id="api-key-input" placeholder="Nhập API Key của bạn...">
                <button class="btn btn-primary" id="save-api-btn">
                    <i class="fas fa-save"></i> Lưu Key
                </button>
            </div>
            <div id="api-status" style="margin-top: 10px; font-weight: 500;"></div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <div class="main-content">
            <!-- Practice Section -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-pencil-alt"></i> Luyện Viết Câu
                </div>
                <div class="card-body">
                    <div class="practice-section">
                        <div class="vietnamese-text" id="vietnamese-text">
                            Chào buổi sáng, hôm nay bạn thế nào?
                        </div>
                        
                        <div class="translation-input">
                            <textarea id="sentence-input" placeholder="Viết bản dịch tiếng Anh của bạn tại đây..."></textarea>
                        </div>
                        
                        <div class="action-buttons">
                            <button class="btn btn-outline" id="skip-btn">
                                <i class="fas fa-forward"></i> Câu tiếp
                            </button>
                            <button class="btn btn-primary" id="submit-btn">
                                <i class="fas fa-paper-plane"></i> Gửi đáp án
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Feedback Section -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-comments"></i> Phản hồi từ AI
                </div>
                <div class="card-body">
                    <div class="feedback-section">
                        <div class="feedback-title">
                            <i class="fas fa-lightbulb"></i> Nhận xét của Gemini AI
                        </div>
                        
                        <div class="spinner" id="spinner">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Đang xử lý...</span>
                            </div>
                            <p class="mt-2">AI đang phân tích câu trả lời của bạn</p>
                        </div>
                        
                        <div class="feedback-content" id="feedback-content">
                            <div id="default-feedback">
                                <p>Nhập câu trả lời của bạn và nhấn "Gửi đáp án" để nhận phản hồi từ Gemini AI.</p>
                                <p>Hệ thống sẽ kiểm tra bản dịch của bạn và chỉ ra các lỗi cũng như gợi ý cải thiện.</p>
                            </div>
                            
                            <div class="suggestion-text" id="suggestion-text" style="display: none;"></div>
                            <ul class="error-list" id="errors" style="display: none;"></ul>
                            <div class="summary" id="summary" style="display: none;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="social-links">
                    <a href="#"><i class="fab fa-facebook"></i></a>
                    <a href="#"><i class="fab fa-twitter"></i></a>
                    <a href="#"><i class="fab fa-instagram"></i></a>
                    <a href="#"><i class="fab fa-github"></i></a>
                </div>
                <p>© 2023 Luyện Viết Câu với AI. Tất cả quyền được bảo lưu.</p>
            </div>
        </div>
    </footer>

    <script>
        // Sample sentences data (in a real app, this would be loaded from sentence.json)
        const sentences = [
            { id: 1, vi: "Chào buổi sáng, hôm nay bạn thế nào?", en: "Good morning, how are you today?" },
            { id: 2, vi: "Tôi thích đọc sách vào thời gian rảnh.", en: "I like reading books in my free time." },
            { id: 3, vi: "Thời tiết hôm nay thật đẹp phải không?", en: "The weather is beautiful today, isn't it?" },
            { id: 4, vi: "Bạn có kế hoạch gì cho cuối tuần này không?", en: "Do you have any plans for this weekend?" },
            { id: 5, vi: "Tôi đang học lập trình web.", en: "I'm learning web programming." },
            { id: 6, vi: "Món ăn Việt Nam rất ngon và đa dạng.", en: "Vietnamese cuisine is delicious and diverse." },
            { id: 7, vi: "Anh ấy làm việc tại một công ty công nghệ.", en: "He works at a technology company." },
            { id: 8, vi: "Chúng tôi sẽ đi du lịch vào mùa hè tới.", en: "We will travel next summer." },
            { id: 9, vi: "Cô ấy nói được ba thứ tiếng.", en: "She can speak three languages." },
            { id: 10, vi: "Bạn có thể giúp tôi một chút được không?", en: "Could you help me a little?" }
        ];

        // DOM Elements
        const apiKeyInput = document.getElementById('api-key-input');
        const saveApiBtn = document.getElementById('save-api-btn');
        const apiStatus = document.getElementById('api-status');
        const vietnameseText = document.getElementById('vietnamese-text');
        const sentenceInput = document.getElementById('sentence-input');
        const skipBtn = document.getElementById('skip-btn');
        const submitBtn = document.getElementById('submit-btn');
        const spinner = document.getElementById('spinner');
        const suggestionText = document.getElementById('suggestion-text');
        const errorsList = document.getElementById('errors');
        const summary = document.getElementById('summary');
        const defaultFeedback = document.getElementById('default-feedback');

        // App State
        let currentSentenceIndex = 0;
        let geminiApiKey = localStorage.getItem('gemini_api_key') || '';

        // Initialize the app
        function initApp() {
            // Load API key if exists
            if (geminiApiKey) {
                apiKeyInput.value = geminiApiKey;
                apiStatus.textContent = '✅ API Key đã được lưu';
                apiStatus.style.color = 'green';
            } else {
                apiStatus.textContent = '⚠️ Vui lòng nhập API Key để sử dụng Gemini AI';
                apiStatus.style.color = '#e74c3c';
            }
            
            // Load first sentence
            loadSentence();
        }

        // Load a sentence
        function loadSentence() {
            vietnameseText.textContent = sentences[currentSentenceIndex].vi;
            sentenceInput.value = '';
            clearFeedback();
        }

        // Clear feedback area
        function clearFeedback() {
            defaultFeedback.style.display = 'block';
            suggestionText.style.display = 'none';
            errorsList.style.display = 'none';
            summary.style.display = 'none';
        }

        // Save API key
        saveApiBtn.addEventListener('click', () => {
            const key = apiKeyInput.value.trim();
            
            if (key) {
                localStorage.setItem('gemini_api_key', key);
                geminiApiKey = key;
                apiStatus.textContent = '✅ API Key đã được lưu';
                apiStatus.style.color = 'green';
            } else {
                apiStatus.textContent = '⚠️ Vui lòng nhập API Key';
                apiStatus.style.color = '#e74c3c';
            }
        });

        // Skip to next sentence
        skipBtn.addEventListener('click', () => {
            currentSentenceIndex = (currentSentenceIndex + 1) % sentences.length;
            loadSentence();
        });

        // Submit translation for checking
        submitBtn.addEventListener('click', async () => {
            if (!geminiApiKey) {
                apiStatus.textContent = '⚠️ Vui lòng nhập API Key trước khi gửi';
                apiStatus.style.color = '#e74c3c';
                return;
            }
            
            const studentTranslation = sentenceInput.value.trim();
            
            if (!studentTranslation) {
                alert('Vui lòng nhập bản dịch của bạn trước khi gửi');
                return;
            }
            
            // Show spinner while processing
            spinner.style.display = 'block';
            defaultFeedback.style.display = 'none';
            
            try {
                // Get feedback from Gemini AI
                const feedback = await getGeminiFeedback(
                    sentences[currentSentenceIndex].vi, 
                    studentTranslation
                );
                
                // Display feedback
                displayFeedback(feedback);
            } catch (error) {
                console.error('Error getting feedback:', error);
                alert('Đã xảy ra lỗi khi kết nối với Gemini AI. Vui lòng thử lại.');
            } finally {
                // Hide spinner
                spinner.style.display = 'none';
            }
        });

        // Get feedback from Gemini AI
        async function getGeminiFeedback(vietnamese, studentTranslation) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;
            
            // Construct the prompt
            const prompt = `Bạn là một giáo viên dạy tiếng Anh. Hãy kiểm tra bản dịch của học sinh và đưa ra nhận xét.
            
            Câu gốc tiếng Việt: "${vietnamese}"
            Câu dịch của học sinh: "${studentTranslation}"
            
            Hãy thực hiện các bước sau:
            1. Dịch câu tiếng Việt trên sang tiếng Anh (bản dịch chuẩn)
            2. So sánh bản dịch của học sinh với bản dịch chuẩn
            3. Chỉ ra lỗi (nếu có) và giải thích ngắn gọn
            4. Đưa ra gợi ý cải thiện
            
            Kết quả trả về dưới dạng JSON với cấu trúc:
            {
                "correction": "Bản dịch chuẩn",
                "suggestions": ["Gợi ý 1", "Gợi ý 2", ...],
                "explanation": "Giải thích tổng quan về lỗi và cách cải thiện"
            }`;
            
            const requestBody = {
                contents: [{
                    parts: [{
                        text: prompt
                    }]
                }],
                generationConfig: {
                    temperature: 0.7,
                    maxOutputTokens: 800
                }
            };
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });
            
            if (!response.ok) {
                throw new Error(`Gemini API error: ${response.status}`);
            }
            
            const data = await response.json();
            const responseText = data.candidates[0].content.parts[0].text;
            
            // Extract JSON from the response
            try {
                // Find JSON substring in the response
                const jsonStart = responseText.indexOf('{');
                const jsonEnd = responseText.lastIndexOf('}') + 1;
                const jsonString = responseText.substring(jsonStart, jsonEnd);
                
                return JSON.parse(jsonString);
            } catch (e) {
                console.error('Error parsing Gemini response:', e);
                return {
                    correction: sentences[currentSentenceIndex].en,
                    suggestions: ["Không thể phân tích phản hồi từ AI"],
                    explanation: "Xin lỗi, đã xảy ra lỗi khi phân tích phản hồi từ Gemini AI."
                };
            }
        }

        // Display feedback from Gemini
        function displayFeedback(feedback) {
            // Show all feedback elements
            suggestionText.style.display = 'block';
            errorsList.style.display = 'block';
            summary.style.display = 'block';
            defaultFeedback.style.display = 'none';
            
            // Display correction
            suggestionText.innerHTML = `<strong>Bản dịch gợi ý:</strong> ${feedback.correction}`;
            
            // Display suggestions
            errorsList.innerHTML = '';
            if (feedback.suggestions && feedback.suggestions.length > 0) {
                feedback.suggestions.forEach(suggestion => {
                    const li = document.createElement('li');
                    li.textContent = suggestion;
                    errorsList.appendChild(li);
                });
            } else {
                const li = document.createElement('li');
                li.textContent = "Bản dịch của bạn rất tốt! Không có lỗi cần sửa.";
                errorsList.appendChild(li);
            }
            
            // Display explanation
            summary.innerHTML = `<strong>Nhận xét:</strong> ${feedback.explanation}`;
        }

        // Initialize the app when the page loads
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>