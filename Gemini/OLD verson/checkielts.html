<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chấm Điểm IELTS Writing - Gemini AI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="icon" href="ielts.png">
    <style>
        :root {
            --primary-color: #4285f4;
            --secondary-color: #34a853;
            --accent-color: #ea4335;
            --background-color: #f8f9fa;
            --card-color: #ffffff;
            --text-color: #202124;
            --border-color: #dadce0;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            background: linear-gradient(135deg, #f8f9fa 0%, #eef2f6 100%);
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: var(--card-color);
            border-radius: 16px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(66, 133, 244, 0.1);
        }
        
        header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color), var(--accent-color));
            border-radius: 16px 16px 0 0;
        }
        
        h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 2.5rem;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .subtitle {
            color: #5f6368;
            font-size: 1.2rem;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background: var(--card-color);
            border-radius: 16px;
            box-shadow: var(--shadow);
            padding: 25px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            border: 1px solid rgba(66, 133, 244, 0.1);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        
        .card h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border-color);
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #3c4043;
        }
        
        input[type="text"], textarea {
            width: 100%;
            padding: 14px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2);
        }
        
        textarea {
            min-height: 200px;
            resize: vertical;
        }
        
        .task-selection {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .task-option {
            flex: 1;
            text-align: center;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .task-option:hover {
            border-color: var(--primary-color);
        }
        
        .task-option.selected {
            border-color: var(--primary-color);
            background-color: rgba(66, 133, 244, 0.1);
        }
        
        .task-option h3 {
            margin-bottom: 8px;
            color: var(--text-color);
            font-size: 1.1rem;
        }
        
        .task-option p {
            color: #5f6368;
            font-size: 0.85rem;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            min-width: 110px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #3367d6;
        }
        
        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #2d8c4d;
        }
        
        .btn-accent {
            background-color: var(--accent-color);
            color: white;
        }
        
        .btn-accent:hover {
            background-color: #d23a2e;
        }
        
        .result-container {
            margin-top: 30px;
        }
        
        .result-content {
            background: var(--card-color);
            border-radius: 16px;
            padding: 25px;
            box-shadow: var(--shadow);
            min-height: 200px;
            border: 1px solid rgba(66, 133, 244, 0.1);
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .vocabulary-container {
            margin-top: 30px;
            background: var(--card-color);
            border-radius: 16px;
            padding: 25px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(66, 133, 244, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .vocab-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .vocab-header h2 {
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.8rem;
        }
        
        /* Nút toggle từ vựng - gọn hơn */
        .vocab-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(to right, var(--primary-color), #5a8dee);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 14px;
            box-shadow: 0 2px 6px rgba(66, 133, 244, 0.3);
        }
        
        .vocab-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(66, 133, 244, 0.4);
            background: linear-gradient(to right, #3a75e0, #4e82e8);
        }
        
        .vocab-toggle:active {
            transform: translateY(1px);
        }
        
        .vocab-toggle.hidden {
            background: linear-gradient(to right, #ea4335, #f15c50);
            box-shadow: 0 2px 6px rgba(234, 67, 53, 0.3);
        }
        
        .vocab-toggle.hidden:hover {
            background: linear-gradient(to right, #d9382c, #e64a3e);
            box-shadow: 0 4px 10px rgba(234, 67, 53, 0.4);
        }
        
        .toggle-icon {
            font-size: 1rem;
        }
        
        .vocabulary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            transition: opacity 0.3s ease;
        }
        
        .vocabulary-grid.hidden {
            display: none;
        }
        
        .vocab-card {
            background: white;
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
            border-left: 4px solid var(--secondary-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .vocab-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--secondary-color);
        }
        
        .vocab-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 12px rgba(0, 0, 0, 0.1);
        }
        
        .vocab-card h4 {
            color: var(--primary-color);
            margin-bottom: 8px;
            font-size: 1.15rem;
        }
        
        .pos {
            font-style: italic;
            color: #5f6368;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }
        
        .meaning {
            color: var(--text-color);
            line-height: 1.5;
            font-size: 0.95rem;
        }
        
        .vocab-placeholder {
            text-align: center;
            padding: 30px 20px;
            color: #5f6368;
            font-style: italic;
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            margin-top: 10px;
            background-color: rgba(248, 249, 250, 0.5);
        }
        
        .vocab-placeholder i {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 15px;
            display: block;
        }
        
        .score-display {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .score-card {
            background: var(--card-color);
            border-radius: 10px;
            padding: 18px;
            text-align: center;
            min-width: 130px;
            box-shadow: var(--shadow);
            border-top: 4px solid var(--primary-color);
        }
        
        .score-label {
            font-size: 0.95rem;
            color: #5f6368;
            margin-bottom: 8px;
        }
        
        .score-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .criteria {
            margin-top: 20px;
        }
        
        .criterion {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .criterion:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .criterion h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.3rem;
        }
        
        .feedback {
            line-height: 1.7;
        }
        
        .feedback p {
            margin-bottom: 10px;
        }
        
        footer {
            text-align: center;
            padding: 30px 0;
            color: #5f6368;
            margin-top: 40px;
            border-top: 1px solid var(--border-color);
            font-size: 0.95rem;
        }
        
        .error {
            color: var(--accent-color);
            padding: 15px;
            background: rgba(234, 67, 53, 0.1);
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }
        
        .api-info {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 5px;
            font-size: 0.9rem;
            color: #5f6368;
        }
        
        .api-info a {
            color: var(--primary-color);
            text-decoration: none;
        }
        
        .api-info a:hover {
            text-decoration: underline;
        }
        
        .gemini-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(90deg, #4285f4, #34a853, #ea4335);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 5px;
        }
        
        .vocab-loading {
            text-align: center;
            padding: 20px;
            color: #5f6368;
        }
        
        .vocab-loading .spinner {
            margin: 0 auto 15px;
        }
        
        .criteria-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .criterion-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid var(--primary-color);
        }
        
        /* Kiểu cho kết quả đánh giá đẹp mắt */
        .result-card {
            background: var(--card-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
        }
        
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .result-title {
            color: var(--primary-color);
            font-size: 1.4rem;
            font-weight: 600;
        }
        
        .result-score {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
            background: rgba(66, 133, 244, 0.1);
            padding: 5px 15px;
            border-radius: 8px;
        }
        
        .criteria-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .criteria-item {
            padding: 15px;
            border-radius: 8px;
            background: #f8f9fa;
            border-left: 4px solid var(--secondary-color);
        }
        
        .criteria-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .criteria-name {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .criteria-point {
            font-weight: 700;
            color: var(--secondary-color);
        }
        
        .criteria-feedback {
            line-height: 1.6;
        }
        
        .suggestion-list {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px dashed var(--border-color);
        }
        
        .suggestion-list li {
            margin-bottom: 10px;
            padding-left: 20px;
            position: relative;
        }
        
        .suggestion-list li:before {
            content: "•";
            position: absolute;
            left: 0;
            color: var(--primary-color);
            font-weight: bold;
        }
        
        .gemini-footer {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            font-style: italic;
            color: #5f6368;
        }
    </style>
</head>
<body>
    <header>
        <h1><i class="fas fa-pen-fancy"></i> Chấm Điểm IELTS Writing</h1>
        <p class="subtitle">Công cụ đánh giá bài viết IELTS với trí tuệ nhân tạo Gemini</p>
        <div class="gemini-badge">
            <i class="fas fa-robot"></i>
            <span>Powered by Gemini API</span>
        </div>
    </header>
    
    <div class="container">
        <div class="card">
            <h2><i class="fas fa-edit"></i> Thông tin bài viết</h2>
            
            <div class="form-group">
                <label for="api-key">API Key Gemini:</label>
                <input type="text" id="api-key" placeholder="Nhập API Key của bạn...">
                <div class="api-info">
                    <i class="fas fa-info-circle"></i>
                    <span>Lấy API Key tại: <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a></span>
                </div>
            </div>
            
            <div class="form-group">
                <label>Chọn Task:</label>
                <div class="task-selection">
                    <div class="task-option selected" data-task="task1">
                        <h3><i class="fas fa-chart-bar"></i> Task 1</h3>
                        <p>Mô tả biểu đồ, bản đồ, quy trình</p>
                    </div>
                    <div class="task-option" data-task="task2">
                        <h3><i class="fas fa-comments"></i> Task 2</h3>
                        <p>Bài luận về quan điểm, thảo luận</p>
                    </div>
                </div>
                <input type="hidden" id="task-type" value="task1">
            </div>
            
            <div class="form-group">
                <label for="topic">Đề bài / Topic:</label>
                <input type="text" id="topic" placeholder="Nhập đề bài IELTS...">
            </div>
            
            <div class="form-group">
                <label for="essay">Bài viết của bạn:</label>
                <textarea id="essay" placeholder="Nhập bài viết của bạn tại đây..."></textarea>
            </div>
            
            <div class="button-group">
                <button id="grade-btn" class="btn-primary">
                    <i class="fas fa-check-circle"></i> Chấm điểm
                </button>
                <button id="reset-btn" class="btn-accent">
                    <i class="fas fa-redo"></i> Làm lại
                </button>
                <button id="vocab-btn" class="btn-secondary">
                    <i class="fas fa-book"></i> Từ điển
                </button>
            </div>
        </div>
        
        <div class="card">
            <h2><i class="fas fa-info-circle"></i> Hướng dẫn sử dụng</h2>
            <div class="instructions">
                <h3><i class="fas fa-play-circle"></i> Cách sử dụng công cụ:</h3>
                <ol>
                    <li>Nhập API Key Gemini của bạn (cần có tài khoản Google)</li>
                    <li>Chọn Task 1 hoặc Task 2 tùy theo bài viết</li>
                    <li>Nhập đề bài vào ô "Đề bài / Topic"</li>
                    <li>Nhập bài viết của bạn vào ô "Bài viết của bạn"</li>
                    <li>Nhấn "Chấm điểm" để nhận đánh giá chi tiết</li>
                    <li>Nhấn "Từ điển" để xem các từ vựng liên quan đến chủ đề</li>
                </ol>
                
                <h3><i class="fas fa-star"></i> Tiêu chí chấm điểm:</h3>
                <ul>
                    <li><strong>Task Achievement (Task 1) / Task Response (Task 2)</strong>: Hoàn thành yêu cầu đề bài</li>
                    <li><strong>Coherence and Cohesion</strong>: Tính mạch lạc và liên kết</li>
                    <li><strong>Lexical Resource</strong>: Vốn từ vựng</li>
                    <li><strong>Grammatical Range and Accuracy</strong>: Ngữ pháp đa dạng và chính xác</li>
                </ul>
                
                <h3><i class="fas fa-exclamation-triangle"></i> Lưu ý:</h3>
                <p>Để có kết quả tốt nhất, hãy đảm bảo bài viết đủ dài (tối thiểu 150 từ cho Task 1 và 250 từ cho Task 2). Kết quả chấm điểm chỉ mang tính chất tham khảo.</p>
            </div>
        </div>
    </div>
    
    <div class="vocabulary-container">
        <div class="vocab-header">
            <h2><i class="fas fa-book-open"></i> Từ vựng liên quan</h2>
            <button class="vocab-toggle" id="vocab-toggle">
                <i class="fas fa-eye-slash toggle-icon"></i>
                <span class="toggle-text">Hiện từ vựng</span>
            </button>
        </div>
        <div class="vocabulary-grid hidden" id="vocabulary-grid">
            <!-- Vocabulary cards will be inserted here -->
        </div>
        <div class="vocab-placeholder" id="vocab-placeholder">
            <i class="fas fa-book"></i>
            <p>Nhấn nút <strong>"Từ điển"</strong> để xem các từ vựng liên quan đến chủ đề</p>
        </div>
    </div>
    
    <div class="result-container">
        <h2><i class="fas fa-chart-line"></i> Kết quả chấm điểm</h2>
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Đang chấm điểm bài viết với Gemini AI, vui lòng chờ...</p>
            <p><small>Thời gian xử lý: ~10-30 giây</small></p>
        </div>
        <div class="error" id="error-msg"></div>
        <div class="result-content" id="result-content">
            <p>Kết quả chấm điểm sẽ hiển thị tại đây sau khi bạn nhấn nút "Chấm điểm".</p>
        </div>
    </div>
    
    <footer>
        <p>Công cụ chấm điểm IELTS Writing sử dụng Gemini AI | Phiên bản 5.0</p>
        <p>Lưu ý: Kết quả chấm điểm chỉ mang tính chất tham khảo</p>
    </footer>

    <script>
        // Khởi tạo biến và chọn task
        document.addEventListener('DOMContentLoaded', function() {
            const taskOptions = document.querySelectorAll('.task-option');
            const taskTypeInput = document.getElementById('task-type');
            
            taskOptions.forEach(option => {
                option.addEventListener('click', function() {
                    taskOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    taskTypeInput.value = this.dataset.task;
                });
            });
            
            // Xử lý nút làm lại
            document.getElementById('reset-btn').addEventListener('click', function() {
                document.getElementById('topic').value = '';
                document.getElementById('essay').value = '';
                document.getElementById('result-content').innerHTML = '<p>Kết quả chấm điểm sẽ hiển thị tại đây sau khi bạn nhấn nút "Chấm điểm".</p>';
                document.getElementById('vocabulary-grid').innerHTML = '';
                document.getElementById('vocab-placeholder').style.display = 'block';
                document.getElementById('vocabulary-grid').classList.add('hidden');
                document.getElementById('vocab-toggle').classList.remove('hidden');
                document.getElementById('vocab-toggle').querySelector('.toggle-icon').className = 'fas fa-eye-slash toggle-icon';
                document.getElementById('vocab-toggle').querySelector('.toggle-text').textContent = 'Hiện từ vựng';
                document.getElementById('error-msg').style.display = 'none';
            });
            
            // Xử lý nút chấm điểm với Gemini API
            document.getElementById('grade-btn').addEventListener('click', async function() {
                const apiKey = document.getElementById('api-key').value;
                const taskType = document.getElementById('task-type').value;
                const topic = document.getElementById('topic').value;
                const essay = document.getElementById('essay').value;
                
                if (!apiKey) {
                    showError('Vui lòng nhập API Key Gemini');
                    return;
                }
                
                if (!topic) {
                    showError('Vui lòng nhập đề bài');
                    return;
                }
                
                if (!essay) {
                    showError('Vui lòng nhập bài viết');
                    return;
                }
                
                // Hiển thị loading
                document.getElementById('loading').style.display = 'block';
                document.getElementById('error-msg').style.display = 'none';
                
                // Gửi yêu cầu đến Gemini
                await gradeEssayWithGemini(apiKey, taskType, topic, essay);
            });
            
            // Xử lý nút từ điển
            document.getElementById('vocab-btn').addEventListener('click', async function() {
                const apiKey = document.getElementById('api-key').value;
                const topic = document.getElementById('topic').value;
                
                if (!apiKey) {
                    showError('Vui lòng nhập API Key Gemini');
                    return;
                }
                
                if (!topic) {
                    showError('Vui lòng nhập đề bài để tạo từ điển');
                    return;
                }
                
                // Hiển thị loading cho từ điển
                document.getElementById('vocab-placeholder').innerHTML = `
                    <div class="vocab-loading">
                        <div class="spinner"></div>
                        <p>Đang tạo từ điển với Gemini, vui lòng chờ...</p>
                    </div>
                `;
                document.getElementById('error-msg').style.display = 'none';
                
                // Gửi yêu cầu tạo từ điển
                await generateVocabularyWithGemini(apiKey, topic);
            });
            
            // Xử lý nút toggle từ vựng
            const vocabToggle = document.getElementById('vocab-toggle');
            const vocabGrid = document.getElementById('vocabulary-grid');
            const vocabPlaceholder = document.getElementById('vocab-placeholder');
            const toggleIcon = vocabToggle.querySelector('.toggle-icon');
            const toggleText = vocabToggle.querySelector('.toggle-text');
            
            let isVocabVisible = false;
            
            vocabToggle.addEventListener('click', function() {
                isVocabVisible = !isVocabVisible;
                
                if (isVocabVisible) {
                    vocabGrid.classList.remove('hidden');
                    vocabPlaceholder.style.display = 'none';
                    toggleIcon.className = 'fas fa-eye toggle-icon';
                    toggleText.textContent = 'Ẩn từ vựng';
                } else {
                    vocabGrid.classList.add('hidden');
                    vocabPlaceholder.style.display = 'block';
                    toggleIcon.className = 'fas fa-eye-slash toggle-icon';
                    toggleText.textContent = 'Hiện từ vựng';
                }
            });
        });
        
        // Hiển thị lỗi
        function showError(message) {
            const errorElement = document.getElementById('error-msg');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }
        
        // Gửi yêu cầu chấm điểm đến Gemini API
        async function gradeEssayWithGemini(apiKey, taskType, topic, essay) {
            try {
                // Tạo prompt cho Gemini
                const prompt = `Bạn là một giám khảo IELTS chuyên nghiệp. Hãy chấm điểm bài viết IELTS Writing ${taskType === 'task1' ? 'Task 1' : 'Task 2'} theo thang điểm IELTS chính thức (0-9) dựa trên các tiêu chí: 
${taskType === 'task1' ? '- Task Achievement' : '- Task Response'}, 
- Coherence and Cohesion, 
- Lexical Resource, 
- Grammatical Range and Accuracy.

Đề bài: "${topic}"

Bài viết:
"${essay}"

Hãy trả lời bằng tiếng Việt và theo cấu trúc sau:

1. Tổng điểm: [số điểm]
2. Phân tích chi tiết từng tiêu chí:
   a. ${taskType === 'task1' ? 'Task Achievement' : 'Task Response'}: 
      - Điểm: [số điểm]
      - Nhận xét: [phản hồi chi tiết]
   b. Coherence and Cohesion: 
      - Điểm: [số điểm]
      - Nhận xét: [phản hồi chi tiết]
   c. Lexical Resource: 
      - Điểm: [số điểm]
      - Nhận xét: [phản hồi chi tiết]
   d. Grammatical Range and Accuracy: 
      - Điểm: [số điểm]
      - Nhận xét: [phản hồi chi tiết]
3. Đề xuất cải thiện: [các gợi ý để cải thiện bài viết]

Hãy trả lời dưới dạng HTML đẹp mắt để hiển thị trên web.`;

                // Gửi request đến Gemini API
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    })
                });

                const data = await response.json();
                
                // Ẩn loading
                document.getElementById('loading').style.display = 'none';
                
                if (!response.ok) {
                    throw new Error(data.error?.message || 'Lỗi khi kết nối với Gemini API');
                }
                
                // Lấy kết quả từ Gemini
                const geminiText = data.candidates[0].content.parts[0].text;
                
                // Hiển thị kết quả
                displayGradingResult(geminiText);
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                showError(`Lỗi: ${error.message}. Vui lòng kiểm tra API Key và thử lại.`);
            }
        }
        
        // Hiển thị kết quả chấm điểm dạng HTML đẹp mắt
        function displayGradingResult(resultHTML) {
// Loại bỏ các ký tự markdown không mong muốn
        let cleanHTML = resultHTML
            .replace(/```html/g, '')
            .replace(/```/g, '')
            .trim();
        
      
            document.getElementById('result-content').innerHTML = resultHTML;
        }
        
        // Tạo từ điển từ vựng với Gemini API
        async function generateVocabularyWithGemini(apiKey, topic) {
            try {
                // Tạo prompt cho Gemini
                const prompt = `Hãy cung cấp một danh sách 8 từ vựng học thuật liên quan đến chủ đề "${topic}" cho bài thi IELTS. 
Mỗi từ vựng cần bao gồm: 
- Từ vựng (tiếng Anh)
- Loại từ (viết tắt: n, v, adj, adv)
- Nghĩa tiếng Việt (giải thích ngắn gọn)

Trả lời theo định dạng JSON như sau:
{
  "vocabulary": [
    {
      "word": "Từ vựng",
      "pos": "Loại từ",
      "meaning": "Nghĩa tiếng Việt"
    },
    ...
  ]
}`;

                // Gửi request đến Gemini API
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error?.message || 'Lỗi khi kết nối với Gemini API');
                }
                
                // Lấy kết quả từ Gemini
                const geminiText = data.candidates[0].content.parts[0].text;
                
                // Cố gắng phân tích JSON từ phản hồi
                try {
                    // Tìm vị trí bắt đầu và kết thúc của JSON
                    const jsonStart = geminiText.indexOf('{');
                    const jsonEnd = geminiText.lastIndexOf('}') + 1;
                    const jsonString = geminiText.substring(jsonStart, jsonEnd);
                    
                    const vocabData = JSON.parse(jsonString);
                    displayVocabulary(vocabData.vocabulary);
                } catch (error) {
                    // Nếu không phân tích được JSON, hiển thị thông báo lỗi
                    showError('Không thể phân tích từ vựng từ Gemini. Vui lòng thử lại.');
                    document.getElementById('vocab-placeholder').innerHTML = `
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Không thể tạo từ điển. Vui lòng thử lại hoặc nhập chủ đề khác.</p>
                    `;
                }
            } catch (error) {
                showError(`Lỗi khi tạo từ điển: ${error.message}. Vui lòng thử lại.`);
                document.getElementById('vocab-placeholder').innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>Không thể kết nối với Gemini. Vui lòng kiểm tra API Key và thử lại.</p>
                `;
            }
        }
        
        // Hiển thị từ vựng
        function displayVocabulary(vocabItems) {
            let vocabHTML = '';
            
            vocabItems.forEach(item => {
                vocabHTML += `
                    <div class="vocab-card">
                        <h4>${item.word}</h4>
                        <div class="pos">${getFullPOS(item.pos)}</div>
                        <div class="meaning">${item.meaning}</div>
                    </div>
                `;
            });
            
            document.getElementById('vocabulary-grid').innerHTML = vocabHTML;
            document.getElementById('vocab-placeholder').style.display = 'none';
            document.getElementById('vocabulary-grid').classList.remove('hidden');
            
            // Hiển thị từ vựng và cập nhật nút toggle
            document.getElementById('vocab-toggle').querySelector('.toggle-icon').className = 'fas fa-eye toggle-icon';
            document.getElementById('vocab-toggle').querySelector('.toggle-text').textContent = 'Ẩn từ vựng';
            document.getElementById('vocab-toggle').classList.remove('hidden');
        }
        
        // Hàm trợ giúp - chuyển đổi viết tắt loại từ thành tên đầy đủ
        function getFullPOS(abbr) {
            const posMap = {
                'n': 'Danh từ',
                'v': 'Động từ',
                'adj': 'Tính từ',
                'adv': 'Trạng từ',
                'prep': 'Giới từ',
                'conj': 'Liên từ'
            };
            return posMap[abbr] || abbr;
        }
    </script>
</body>
</html>